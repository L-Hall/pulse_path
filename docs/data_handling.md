Below is a ‚Äúreverse-engineering-style‚Äù breakdown of what the screenshots reveal about **Welltory‚Äôs** inner workings, followed by concrete tips, formulas and sample Dart code you can lift straight into **Pulse Path**.

---

## 1  UI & state-management clues

| Screenshot element                                                     | What it implies about the code                                                                                                                                                |
| ---------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Nested scrolling cards** with their own headers and tool-tip buttons | Probably a `CustomScrollView` (Flutter) or native *UIScroll/Recycler* screen composed of **slivers**/sections. Each card is a reusable widget fed by a stream of metric data. |
| **Day / Week / Month** segmented control that animates with ‚ú®          | A `ToggleButtons`/`CupertinoSlidingSegmentedControl` backed by a view-model that switches **aggregation granularity** on the fly.                                             |
| **Spark-line & bar charts** inside each card                           | Custom `CustomPainter` or a lightweight chart lib (e.g. `fl_chart`) drawing off in-memory lists of points pre-aggregated server-side or in a local DB.                        |
| **Baseline dashed line** across charts                                 | Each metric carries *(value, personalBaseline, normalRange)* so the painter can render both the user line and the reference line in one pass.                                 |
| **‚Äú9/9 metrics OK‚Äù** banner on the HRV screen                          | There‚Äôs a rule-engine that validates a set of sub-metrics and emits a count of those ‚Äúwithin normal range‚Äù to the UI.                                                         |
| **Insight carousel** (‚ÄúSky‚Äôs the limit‚Ä¶‚Äù)                              | Text + emoji is generated by a *Rule/ML* engine and pushed as a list ‚Üí fed to a `PageView` or `CarouselSlider`.                                                               |

### Likely architecture

* **Data layer**
  *HealthKit/Google Fit adapters ‚Üí Sensor streams ‚Üí `HrvRepository` (local cache + sync)*
* **Domain layer**
  *Pure-Dart ‚Äúcalculators‚Äù for RMSSD, SDNN, AMo50‚Ä¶ plus ‚Äúscore composers‚Äù (Stress, Energy, Health, Focus).*
* **Presentation layer**
  *Riverpod/BLoC emits `AsyncValue<MetricCardState>`; widgets rebuild automatically.*

---

## 2  Core HRV metrics you can replicate

| Metric    | Formula / Rule of thumb             | What it reflects              | Cite                            |            |                     |
| --------- | ----------------------------------- | ----------------------------- | ------------------------------- | ---------- | ------------------- |
| **RMSSD** | `sqrt( Œ£(ŒîRR¬≤)/(N-1) )`             | Short-term parasymp. activity | ([PMC][1])                      |            |                     |
| **SDNN**  | `stdDev(RR)` over 24 h or session   | Global variability            | ([PMC][1])                      |            |                     |
| **pNN50** | \`% of                              | ŒîRR                           | > 50 ms\`                       | Vagal tone | ([welltory.com][2]) |
| **AMo50** | `% of RR within ¬±50 ms of the mode` | Symp./parasymp. balance       | ([Wellhero][3])                 |            |                     |
| **CV**    | `SDNN / meanRR`                     | Overall adaptability          | ([Wellhero][3])                 |            |                     |
| **MxDMn** | `maxRR ‚Äì minRR`                     | Total range of variability    | Welltory‚Äôs docs & HRV textbooks |            |                     |

---

## 3  How the composite ‚Äúscores‚Äù are probably built

> ‚ö†Ô∏è  Exact coefficients are Welltory IP, but the maths below will get you >80 % of the way.

### 3.1 Stress (0‚Äì100 %)

```
stressRaw = clamp( 1 ‚àí (RMSSD_today / RMSSD_baseline), 0, 1 )
stressScore = (stressRaw * 100).round()
```

*Higher than baseline RMSSD ‚áí lower stress.*

### 3.2 Energy / ‚ÄúBattery‚Äù

```
sleepFactor   = lastNightSleepScore / 100          // your existing sleep algo
hrvFactor     = RMSSD_today / RMSSD_baseline
ambientHRFactor = (HR_baseline - HR_day_avg) / HR_baseline

battery = sigmoid(  0.5*sleepFactor
                  + 0.3*hrvFactor
                  + 0.2*ambientHRFactor ) * 100
```

### 3.3 Health (resilience)

```
health = logistic( ln(RMSSD_today) ,  ln(20), ln(120) ) * 100
```

*Maps ln-RMSSD into 0-100 using a 20-120 ms ‚Äúhealthy‚Äù window (WHO ranges).*

### 3.4 Focus

```
focus = clamp( 0.6*parasympActivity + 0.4*(1-stressRaw), 0, 1 ) * 100
```

*Leverages both branches of ANS.*

---

## 4  Sample Dart code (drop-in Calculator class)

```dart
class HrvCalculator {
  /// Root Mean Square of Successive Differences
  double rmssd(List<int> rr) {
    if (rr.length < 2) return double.nan;
    final diffs = [
      for (var i = 1; i < rr.length; i++) pow(rr[i] - rr[i - 1], 2)
    ];
    return sqrt(diffs.reduce((a, b) => a + b) / (diffs.length));
  }

  /// Standard deviation of NN intervals
  double sdnn(List<int> rr) =>
      sqrt(rr.map((e) => pow(e - _mean(rr), 2)).reduce((a, b) => a + b) /
          rr.length);

  /// pNN50
  double pnn50(List<int> rr) {
    if (rr.length < 2) return double.nan;
    final count50 = rr
        .asMap()
        .entries
        .skip(1)
        .where((e) => (rr[e.key] - rr[e.key - 1]).abs() > 50)
        .length;
    return count50 / (rr.length - 1) * 100;
  }

  /// Coefficient of Variation
  double cv(List<int> rr) => sdnn(rr) / _mean(rr);

  // ----- Composite scores --------------------------------------------------

  double stress({required double rmssdToday, required double rmssdBase}) =>
      ((1 - (rmssdToday / rmssdBase)).clamp(0, 1) * 100);

  double battery({
    required double sleepScore,
    required double rmssdToday,
    required double rmssdBase,
    required double ambientHr,
    required double hrBaseline,
  }) {
    final sleep = sleepScore / 100;
    final hrv = rmssdToday / rmssdBase;
    final hr = (hrBaseline - ambientHr) / hrBaseline;
    final raw = 0.5 * sleep + 0.3 * hrv + 0.2 * hr;
    return _sigmoid(raw) * 100;
  }

  // ------------------------------------------------------------------------

  double _mean(List<int> vals) => vals.reduce((a, b) => a + b) / vals.length;

  double _sigmoid(double x) => 1 / (1 + exp(-12 * (x - 0.5)));
}
```

*Plug this class into a Riverpod `FutureProvider` that receives fresh RR-interval batches from your `SimpleHrvRepository`.*

---

## 5  Integration roadmap for Pulse Path

1. **Data ingestion**
   *Add a `RawHrvStream` abstraction* ‚Üí currently you have the mock/simple repo; extend it to read RR arrays from Apple Health or Polar H10.

2. **Baseline service**
   Store a rolling 7-day or 14-day median per metric (`hive` or `sqflite`). Expose it via `BaselineRepository`.

3. **Metric calculators** (above)
   Synchronous, pure-Dart; unit-test each formula.

4. **Score composers**
   Combine metrics + baselines ‚Üí ‚Äústress‚Äù, ‚Äúenergy‚Äù etc. Keep coefficients in a JSON file so you can tweak without re-deploying.

5. **UI layer**
   *Create a reusable `MetricCard` widget* with props: `title`, `value`, `baseline`, `normalRange`, `chartSeries`, `description`. Drive cards from a `List<MetricCardState>` emitted by a Riverpod provider so Day/Week/Month toggles re-query the provider with different granularity.

6. **Insights engine (stretch goal)**
   Encode ‚ÄúIf Energy <40 % and Stress >60 % then show recovery advice‚Äù rules in a YAML file ‚Üí simple DSL ‚Üí surface in a `CarouselSlider`.

---

### Final check-list

* [ ] Anonymous sign-in is working again.
* [ ] RR arrays flowing into your repo.
* [ ] Baseline medians stored and updating nightly.
* [ ] Calculator returns matching values to Welltory within ¬±5 %.
* [ ] Cards render with baselines and coloured captions (‚ÄúBalanced‚Äù, ‚ÄúLow‚Äù‚Ä¶).

Once those are in place, Pulse Path will cover the same functional ground as Welltory‚Äôs metric pages, but under **your** brand and UI style. Give the formulas a spin and ping me if any values look off‚ÄîI can help you fine-tune the coefficients or add frequency-domain metrics (LF/HF) later on. Happy coding! ü©∫üöÄ

[1]: https://pmc.ncbi.nlm.nih.gov/articles/PMC5624990/?utm_source=chatgpt.com "An Overview of Heart Rate Variability Metrics and Norms - PMC"
[2]: https://welltory.com/rmssd-and-other-hrv-measurements/?utm_source=chatgpt.com "RMSSD, pNN50, SDNN and other HRV measurements | Welltory"
[3]: https://wellhero.co/heart-rate-variability-metrics-explained/?utm_source=chatgpt.com "Heart Rate Variability metrics explained - Wellhero"
